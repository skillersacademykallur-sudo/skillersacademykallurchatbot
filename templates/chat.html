<!-- Updated Chatbot HTML with File Upload + Voice Recording -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skillers Chatbot</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css')}}"/>

    <style>
    /* ---------------------- UPDATED CSS BELOW ---------------------- */

    /* File + Voice Button Container */
    .action_buttons {
        display: flex;
        align-items: center;
        margin-right: 10px;
        gap: 10px;
    }

    .action_btn {
        height: 40px;
        width: 40px;
        border-radius: 50%;
        background: rgba(255,255,255,0.15);
        border: 1px solid rgba(255,255,255,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        transition: 0.2s;
    }

    .action_btn:hover {
        background: rgba(255,255,255,0.25);
    }

    #audioRecordBtn.recording {
        background: #ff4757 !important;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(255,71,87,0.6); }
        70% { box-shadow: 0 0 10px 12px rgba(255,71,87,0); }
        100% { box-shadow: 0 0 0 0 rgba(255,71,87,0); }
    }

    /* Display attached file */
    .file_preview {
        color: white;
        font-size: 13px;
        margin-top: 5px;
        opacity: 0.8;
    }
    </style>
</head>

<body>
    <div class="container-fluid h-100 p-0">
        <div class="row justify-content-center h-100 m-0">
            <div class="col-12 col-md-8 col-xl-6 chat p-0">
                <div class="card">

                    <div class="card-header msg_head">
                        <div class="d-flex bd-highlight align-items-center">
                            <div class="img_cont">
                                <img src="{{ url_for('static', filename='images/profile.png') }}" class="user_img" alt="Bot Profile">
                                <span class="online_icon"></span>
                            </div>
                            <div class="user_info ml-3">
                                <span>Skillers Academy</span>
                                <p>Mr. Tikri AI Assistant</p>
                            </div>
                        </div>
                    </div>

                    <div id="messageFormeight" class="card-body msg_card_body">
                        <div class="d-flex justify-content-start mb-4">
                            <div class="img_cont_msg">
                                <img src="{{ url_for('static', filename='images/profile.png') }}" class="rounded-circle user_img_msg">
                            </div>
                            <div class="msg_cotainer">
                                Hello! I am Mr. Tikri. Ask me anything!
                                <span class="msg_time">Now</span>
                            </div>
                        </div>
                        <div id="scroll-anchor"></div>
                    </div>

                    <div class="card-footer">
                        <form id="messageArea" class="input-group" enctype="multipart/form-data">

                            <div class="action_buttons">
                                <!-- File Upload Button -->
                                <label for="fileInput" class="action_btn"><i class="fas fa-paperclip"></i></label>
                                <input id="fileInput" type="file" name="file" style="display:none;">

                                <!-- Voice Recording Button -->
                                <div id="audioRecordBtn" class="action_btn"><i class="fas fa-microphone"></i></div>
                            </div>

                            <input type="text" id="text" name="msg" placeholder="Type your message..." autocomplete="off" class="form-control type_msg" />

                            <div class="input-group-append">
                                <button type="submit" id="send" class="btn send_btn"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </form>
                        <div id="filePreview" class="file_preview"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>
        $(document).ready(function() {
            function smoothScroll() {
                document.getElementById("scroll-anchor").scrollIntoView({ behavior: "smooth", block: "end" });
            }

            // Show file preview
            $("#fileInput").on("change", function() {
                const file = this.files[0];
                if (file) {
                    $("#filePreview").text("ðŸ“Ž Attached: " + file.name);
                }
            });

            // ---------------------- AUDIO RECORDING ----------------------
            let recorder, audioBlob;
            let isRecording = false;

            $("#audioRecordBtn").click(async function () {
                if (!isRecording) {
                    // Start Recording
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    recorder = new MediaRecorder(stream);

                    let chunks = [];
                    recorder.ondataavailable = (e) => chunks.push(e.data);
                    recorder.onstop = () => audioBlob = new Blob(chunks, { type: "audio/webm" });

                    recorder.start();
                    isRecording = true;
                    $(this).addClass("recording");
                } else {
                    // Stop Recording
                    recorder.stop();
                    isRecording = false;
                    $(this).removeClass("recording");
                    $("#filePreview").text("ðŸŽ¤ Voice message ready to send");
                }
            });

            // ---------------------- MESSAGE SEND ----------------------
            $("#messageArea").on("submit", function(event) {
                event.preventDefault();

                const date = new Date();
                const str_time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const rawText = $("#text").val().trim();
                const file = $("#fileInput")[0].files[0];

                if (!rawText && !file && !audioBlob) return;

                // Show user bubble
                let userBubble = rawText || (file ? "ðŸ“Ž Sent file: " + file.name : "ðŸŽ¤ Sent voice message");

                const userHtml = `
                <div class="d-flex justify-content-end mb-4">
                    <div class="msg_cotainer_send">${userBubble}
                    <span class="msg_time_send">${str_time}</span></div>
                    <div class="img_cont_msg"><img src="https://i.ibb.co/d5b84Xw/Untitled-design.png" class="rounded-circle user_img_msg"></div>
                </div>`;

                $(userHtml).insertBefore("#scroll-anchor");
                smoothScroll();

                // Prepare form data
                let formData = new FormData();
                formData.append("msg", rawText);
                if (file) formData.append("file", file);
                if (audioBlob) formData.append("audio", audioBlob, "voice_message.webm");

                $.ajax({
                    url: "/get",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(data) {
                        const botHtml = `
                        <div class="d-flex justify-content-start mb-4">
                            <div class="img_cont_msg"><img src="{{ url_for('static', filename='images/profile.png') }}" class="rounded-circle user_img_msg"></div>
                            <div class="msg_cotainer">${data}<span class="msg_time">${str_time}</span></div>
                        </div>`;

                        $(botHtml).insertBefore("#scroll-anchor");
                        smoothScroll();
                    }
                });

                // Reset fields
                $("#text").val("");
                $("#fileInput").val("");
                audioBlob = null;
                $("#filePreview").text("");
            });
        });
    </script>
</body>
</html>

<!-- Backend additions will follow -->
