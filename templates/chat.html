<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skillers Chatbot</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css')}}"/>

    <style>
        /* --- FIX: Force Modals to appear above the chat window --- */
        .modal {
            z-index: 100050 !important;
        }
        .modal-backdrop {
            z-index: 100040 !important;
        }

        /* Dark Theme for Modals */
        .modal-dark {
            background: rgba(40, 40, 40, 0.95);
            color: white;
            border-radius: 20px;
            border: 1px solid #555;
        }
        .form-control-dark {
            background-color: #555;
            border: 1px solid #444;
            color: white;
        }
        .form-control-dark:focus {
            background-color: #666;
            color: white;
            border-color: #007bff;
        }
        /* Fix for select dropdowns in dark mode */
        select.form-control-dark option {
            background-color: #555;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container-fluid h-100 p-0">
        <div class="row justify-content-center h-100 m-0">
            <div class="col-12 col-md-8 col-xl-6 chat p-0">
                <div class="card">

                    <div class="card-header msg_head">
                        <div class="d-flex bd-highlight align-items-center">
                            <div class="img_cont">
                                <img src="{{ url_for('static', filename='images/profile.png') }}" class="user_img" alt="Bot Profile">
                                <span class="online_icon"></span>
                            </div>
                            <div class="user_info ml-3">
                                <span>Skillers Academy</span>
                                <p id="welcome-text">Mr.Tikri AI Assistant</p>
                            </div>
                        </div>
                    </div>

                    <div id="messageFormeight" class="card-body msg_card_body">
                        <div class="d-flex justify-content-start mb-4">
                            <div class="img_cont_msg">
                                <img src="{{ url_for('static', filename='images/profile.png') }}" class="rounded-circle user_img_msg">
                            </div>
                            <div class="msg_cotainer">
                                <span id="botStartMsg">Hello! I am Mr.Tikri. How can I help?</span>
                                <span class="msg_time">Now</span>
                            </div>
                        </div>
                        <div id="scroll-anchor"></div>
                    </div>

                    <div class="card-footer">
                        <form id="messageArea" class="input-group" enctype="multipart/form-data">

                            <div class="action_buttons">
                                <label for="fileInput" class="action_btn"><i class="fas fa-paperclip"></i></label>
                                <input id="fileInput" type="file" name="file" style="display:none;">

                                <button type="button" id="openFormBtn" class="action_btn" style="border:none; background:transparent;" title="Submit Service Details">
                                    <i class="fas fa-clipboard-list"></i>
                                </button>

                                <div id="audioRecordBtn" class="action_btn"><i class="fas fa-microphone"></i></div>
                            </div>

                            <input type="text" id="text" name="msg" placeholder="Type your message..." autocomplete="off" class="form-control type_msg" />

                            <div class="input-group-append">
                                <button type="submit" id="send" class="btn send_btn"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </form>
                        <div id="filePreview" class="file_preview"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="registerModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content modal-dark">
          <div class="modal-header border-0">
            <h5 class="modal-title">Welcome! Let's get to know you.</h5>
          </div>
          <div class="modal-body">
            <form id="regForm">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="regName" class="form-control" required placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="regPhone" class="form-control" required placeholder="Enter your phone">
                </div>
                <div class="form-group">
                    <label>Email (Optional)</label>
                    <input type="email" id="regEmail" class="form-control" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <div class="input-group">
                        <input type="text" id="regCity" class="form-control" required placeholder="City/Area">
                        <div class="input-group-append">
                            <button class="btn btn-info" type="button" id="geoBtn"><i class="fas fa-map-marker-alt"></i> Auto</button>
                        </div>
                    </div>
                    <input type="hidden" id="regLat">
                    <input type="hidden" id="regLon">
                </div>
                <button type="submit" class="btn btn-primary btn-block" style="border-radius: 20px;">Start Chatting</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="serviceFormModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
          <div class="modal-content modal-dark">
            <div class="modal-header border-0">
              <h5 class="modal-title"><i class="fas fa-file-alt"></i> Submit Service Details</h5>
              <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form id="serviceDetailsForm">
                  <div class="form-row">
                      <div class="form-group col-md-6">
                          <label>Name</label>
                          <input type="text" name="svcName" id="svcName" class="form-control form-control-dark" required>
                      </div>
                      <div class="form-group col-md-6">
                          <label>Phone No</label>
                          <input type="tel" name="svcPhone" id="svcPhone" class="form-control form-control-dark" required>
                      </div>
                  </div>

                  <div class="form-group">
                      <label>Full Address</label>
                      <input type="text" name="svcAddress" class="form-control form-control-dark" placeholder="House No, Street, Landmark">
                  </div>

                  <div class="form-row">
                      <div class="form-group col-md-4">
                          <label>State</label>
                          <input type="text" name="svcState" class="form-control form-control-dark">
                      </div>
                      <div class="form-group col-md-4">
                          <label>District</label>
                          <input type="text" name="svcDistrict" class="form-control form-control-dark">
                      </div>
                      <div class="form-group col-md-4">
                          <label>City / Village</label>
                          <input type="text" name="svcCity" class="form-control form-control-dark">
                      </div>
                  </div>

                  <div class="form-group">
                      <label>Service / Speciality</label>
                      <select name="svcService" class="form-control form-control-dark">
                          <option value="">Select Service...</option>
                          <option value="Business">Business</option>
                          <option value="Personal/ Private">Personal/ Private</option>
                          <option value="Government/ Public">Government/ Public</option>
                          <option value="Others">Others</option>
                      </select>
                  </div>

                  <div class="form-group">
                      <label>Other Details</label>
                      <textarea name="svcDetails" class="form-control form-control-dark" rows="3" placeholder="Describe your requirement..."></textarea>
                  </div>

                  <button type="submit" class="btn btn-success btn-block" style="border-radius: 20px;">Submit Details</button>
              </form>
            </div>
          </div>
        </div>
      </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function() {

            // --- UI Helper ---
            function updateUI(userName) {
                if(userName) {
                    $("#welcome-text").text("Hi " + userName + "!, I'm Mr.Tikri here to help you");
                    $("#botStartMsg").text("Hello " + userName + "! How can I help?");
                }
            }

            // --- Cookie Helper ---
            function getCookie(name) {
                let match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
                return match ? match[2] : null;
            }

            // --- LOGIC: Check Registration ---
            if (!getCookie("user_id")) {
                $("#registerModal").modal("show");
            } else {
                let name = getCookie("user_name");
                updateUI(name);
            }

            // --- Geolocation ---
            $("#geoBtn").click(function() {
                if (navigator.geolocation) {
                    $(this).html('<i class="fas fa-spinner fa-spin"></i>');
                    navigator.geolocation.getCurrentPosition(function(position) {
                        $("#regLat").val(position.coords.latitude);
                        $("#regLon").val(position.coords.longitude);

                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}`)
                        .then(response => response.json())
                        .then(data => {
                            let city = data.address.city || data.address.town || data.address.village || "Detected Location";
                            $("#regCity").val(city);
                            $("#geoBtn").html('<i class="fas fa-check"></i>');
                        });
                    });
                } else {
                    alert("Browser does not support Geolocation");
                }
            });

            // --- Registration Submit ---
            $("#regForm").submit(function(e) {
                e.preventDefault();
                let data = {
                    name: $("#regName").val(),
                    phone: $("#regPhone").val(),
                    email: $("#regEmail").val(),
                    city: $("#regCity").val(),
                    lat: $("#regLat").val(),
                    lon: $("#regLon").val()
                };

                $.post("/register-user", data, function(response) {
                    $("#registerModal").modal("hide");
                    updateUI(data.name);
                    // Update cookies manually for immediate use
                    document.cookie = "user_name=" + data.name + "; path=/";
                    document.cookie = "user_phone=" + data.phone + "; path=/";
                }).fail(function() {
                    alert("Error registering. Try again.");
                });
            });

            // --- FIX: SERVICE FORM HANDLER ---
            // We use $(document).on() to ensure the click is registered properly
            $(document).on('click', '#openFormBtn', function(e) {
                e.preventDefault();
                console.log("Service Button Clicked");

                // Auto-fill
                let storedName = getCookie("user_name");
                let storedPhone = getCookie("user_phone");

                if(storedName) $("#svcName").val(decodeURIComponent(storedName));
                if(storedPhone) $("#svcPhone").val(storedPhone);

                $("#serviceFormModal").modal("show");
            });

            // Submit Service Form
            $("#serviceDetailsForm").submit(function(e) {
                e.preventDefault();

                let formData = $(this).serializeArray();
                let dataObj = {};
                $(formData).each(function(index, obj){
                    dataObj[obj.name] = obj.value;
                });

                $("#serviceFormModal").modal("hide");

                // Show confirmation in chat
                const date = new Date();
                const str_time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                let userHtml = `<div class="d-flex justify-content-end mb-4">
                                    <div class="msg_cotainer_send">
                                        üìù <strong>Form Submitted</strong><br>
                                        Service: ${dataObj.svcService}<br>
                                        City: ${dataObj.svcCity}
                                        <span class="msg_time_send">${str_time}</span>
                                    </div>
                                    <div class="img_cont_msg">
                                        <img src="https://i.ibb.co/d5b84Xw/Untitled-design.png" class="rounded-circle user_img_msg">
                                    </div>
                                </div>`;
                $(userHtml).insertBefore("#scroll-anchor");
                smoothScroll();

                // Send to Backend
                $.post("/submit-service", dataObj, function(response) {
                    let botHtml = `<div class="d-flex justify-content-start mb-4">
                                    <div class="img_cont_msg"><img src="{{ url_for('static', filename='images/profile.png') }}" class="rounded-circle user_img_msg"></div>
                                    <div class="msg_cotainer">Thanks! I've received your details for ${dataObj.svcService}.<span class="msg_time">${str_time}</span></div>
                                   </div>`;
                    $(botHtml).insertBefore("#scroll-anchor");
                    smoothScroll();
                    $("#serviceDetailsForm")[0].reset();
                });
            });

            // --- Chat & File Logic ---
            function smoothScroll() {
                document.getElementById("scroll-anchor").scrollIntoView({ behavior: "smooth", block: "end" });
            }

            $("#fileInput").on("change", function() {
                if (this.files[0]) $("#filePreview").text("üìé Attached: " + this.files[0].name);
            });

            let recorder, audioBlob, isRecording = false;
            $("#audioRecordBtn").click(async function () {
                if (!isRecording) {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    recorder = new MediaRecorder(stream);
                    let chunks = [];
                    recorder.ondataavailable = (e) => chunks.push(e.data);
                    recorder.onstop = () => audioBlob = new Blob(chunks, { type: "audio/webm" });
                    recorder.start();
                    isRecording = true;
                    $(this).addClass("recording");
                } else {
                    recorder.stop();
                    isRecording = false;
                    $(this).removeClass("recording");
                    $("#filePreview").text("üé§ Voice message ready");
                }
            });

            $("#messageArea").on("submit", function(event) {
                event.preventDefault();
                const rawText = $("#text").val().trim();
                const file = $("#fileInput")[0].files[0];
                if (!rawText && !file && !audioBlob) return;

                const date = new Date();
                const str_time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                let userBubble = rawText || (file ? "üìé Sent file" : "üé§ Sent voice");
                let userHtml = `<div class="d-flex justify-content-end mb-4"><div class="msg_cotainer_send">${userBubble}<span class="msg_time_send">${str_time}</span></div><div class="img_cont_msg"><img src="https://i.ibb.co/d5b84Xw/Untitled-design.png" class="rounded-circle user_img_msg"></div></div>`;

                $(userHtml).insertBefore("#scroll-anchor");
                smoothScroll();

                let formData = new FormData();
                formData.append("msg", rawText);
                if (file) formData.append("file", file);
                if (audioBlob) formData.append("audio", audioBlob, "voice.webm");

                $("#text").val("");
                $("#fileInput").val("");
                $("#filePreview").text("");
                audioBlob = null;

                $.ajax({
                    url: "/get",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(data) {
                        let botHtml = `<div class="d-flex justify-content-start mb-4"><div class="img_cont_msg"><img src="{{ url_for('static', filename='images/profile.png') }}" class="rounded-circle user_img_msg"></div><div class="msg_cotainer">${data}<span class="msg_time">${str_time}</span></div></div>`;
                        $(botHtml).insertBefore("#scroll-anchor");
                        smoothScroll();
                    }
                });
            });
        });
    </script>
</body>
</html>